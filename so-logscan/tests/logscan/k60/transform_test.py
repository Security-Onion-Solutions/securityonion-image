import pytest
from src.logscan.k60 import transform
from tests.logscan.helper import build_dataset, check_dataset, get_log_lines

def test_build_dataset():
    log_lines = get_log_lines('k60_dataset_testing.log')

    expected_dataset = [
        ([0.207, 23, 154.818, 50.656], {'model': 'k60', 'top_source_ips': ['192.168.12.94', '192.168.12.60', '192.168.12.243', '192.168.12.68', '192.168.12.219'], 'start_time': '2011-07-06T10:11:58', 'end_time': '2011-07-06T11:10:55', 'num_attempts': 29, 'num_failed': 23, 'avg_failure_interval': '155s'}),
        ([0.5, 4, 897.333, 1200.447], {'model': 'k60', 'top_source_ips': ['192.168.12.86', '192.168.12.209', '192.168.12.140', '192.168.12.229'], 'start_time': '2011-07-08T10:11:49', 'end_time': '2011-07-08T10:57:44', 'num_attempts': 8, 'num_failed': 4, 'avg_failure_interval': '897s'}),
    ]
    
    dataset = build_dataset('k60', log_lines)
    
    assert check_dataset(expected_dataset, dataset) == True


def test_ts_group_gt_3f():
    time_group = [[1309961518.0, 0, '192.168.12.9'], [1309961651.0, 1, '192.168.12.75'], [1309961780.0, 0, '192.168.12.42'], [1309961911.0, 1, '192.168.12.75'], [1309962042.0, 0, '192.168.12.180'], [1309962173.0, 0, '192.168.12.94'], [1309962305.0, 0, '192.168.12.161'], [1309962437.0, 0, '192.168.12.60'], [1309962566.0, 0, '192.168.12.243'], [1309962695.0, 0, '192.168.12.121'], [1309962826.0, 1, '192.168.12.75'], [1309962958.0, 0, '192.168.12.9'], [1309963091.0, 0, '192.168.12.196'], [1309963188.0, 1, '192.168.12.68'], [1309963223.0, 0, '192.168.12.180'], [1309963355.0, 0, '192.168.12.211'], [1309963485.0, 0, '192.168.12.42'], [1309963617.0, 0, '192.168.12.180'], [1309963748.0, 1, '192.168.12.211'], [1309963879.0, 0, '192.168.12.219'], [1309964009.0, 0, '192.168.12.121'], [1309964139.0, 0, '192.168.12.26'], [1309964270.0, 0, '192.168.12.9'], [1309964401.0, 0, '192.168.12.161'], [1309964533.0, 0, '192.168.12.211'], [1309964662.0, 0, '192.168.12.9'], [1309964792.0, 0, '192.168.12.196'], [1309964924.0, 0, '192.168.12.75'], [1309965055.0, 1, '192.168.12.9']]

    assert transform.__ts_group_gt_3f(time_group) == True


def test_ts_group_gt_3f_false():
    time_group = [[1310219861.0, 1, '192.168.12.214'], [1310221989.0, 1, '192.168.12.228']]

    assert transform.__ts_group_gt_3f(time_group) == False


def test_top_ip_list():
    time_group = [
        [1309961518.0, 0, '192.168.12.9'],
        [1309961651.0, 1, '192.168.12.75'],
        [1309961780.0, 0, '192.168.12.42'],
        [1309961911.0, 1, '192.168.12.75'],
        [1309962042.0, 0, '192.168.12.180'],
        [1309962173.0, 0, '192.168.12.94'],
        [1309962305.0, 0, '192.168.12.161'],
        [1309962437.0, 0, '192.168.12.60'],
        [1309962566.0, 0, '192.168.12.243'],
        [1309962695.0, 0, '192.168.12.121'],
        [1309962826.0, 1, '192.168.12.75'],
        [1309962958.0, 0, '192.168.12.9'],
        [1309963091.0, 0, '192.168.12.196'],
        [1309963188.0, 1, '192.168.12.68'],
        [1309963223.0, 0, '192.168.12.180'],
        [1309963355.0, 0, '192.168.12.211'],
        [1309963485.0, 0, '192.168.12.42'],
        [1309963617.0, 0, '192.168.12.180'],
        [1309963748.0, 1, '192.168.12.211'],
        [1309963879.0, 0, '192.168.12.219'],
        [1309964009.0, 0, '192.168.12.121'],
        [1309964139.0, 0, '192.168.12.26'],
        [1309964270.0, 0, '192.168.12.9'],
        [1309964401.0, 0, '192.168.12.161'],
        [1309964533.0, 0, '192.168.12.211'],
        [1309964662.0, 0, '192.168.12.9'],
        [1309964792.0, 0, '192.168.12.196'],
        [1309964924.0, 0, '192.168.12.75'],
        [1309965055.0, 1, '192.168.12.9'],
    ]

    expected_top_ip_list = ['192.168.12.94', '192.168.12.60', '192.168.12.243', '192.168.12.68', '192.168.12.219']

    top_ip_list = transform.__top_ip_list(time_group)

    assert top_ip_list == expected_top_ip_list


def test_timesplit_to_d_md():
    time_group = [
        [1309961518.0, 0, '192.168.12.9'],
        [1309961651.0, 1, '192.168.12.75'],
        [1309961780.0, 0, '192.168.12.42'],
        [1309961911.0, 1, '192.168.12.75'],
        [1309962042.0, 0, '192.168.12.180'],
        [1309962173.0, 0, '192.168.12.94'],
        [1309962305.0, 0, '192.168.12.161'],
        [1309962437.0, 0, '192.168.12.60'],
        [1309962566.0, 0, '192.168.12.243'],
        [1309962695.0, 0, '192.168.12.121'],
        [1309962826.0, 1, '192.168.12.75'],
        [1309962958.0, 0, '192.168.12.9'],
        [1309963091.0, 0, '192.168.12.196'],
        [1309963188.0, 1, '192.168.12.68'],
        [1309963223.0, 0, '192.168.12.180'],
        [1309963355.0, 0, '192.168.12.211'],
        [1309963485.0, 0, '192.168.12.42'],
        [1309963617.0, 0, '192.168.12.180'],
        [1309963748.0, 1, '192.168.12.211'],
        [1309963879.0, 0, '192.168.12.219'],
        [1309964009.0, 0, '192.168.12.121'],
        [1309964139.0, 0, '192.168.12.26'],
        [1309964270.0, 0, '192.168.12.9'],
        [1309964401.0, 0, '192.168.12.161'],
        [1309964533.0, 0, '192.168.12.211'],
        [1309964662.0, 0, '192.168.12.9'],
        [1309964792.0, 0, '192.168.12.196'],
        [1309964924.0, 0, '192.168.12.75'],
        [1309965055.0, 1, '192.168.12.9'],
    ]

    expected_d_md = ([0.207, 23, 154.818, 50.656], {'model': 'k60', 'top_source_ips': ['192.168.12.94', '192.168.12.60', '192.168.12.243', '192.168.12.68', '192.168.12.219'], 'start_time': '2011-07-06T10:11:58', 'end_time': '2011-07-06T11:10:55', 'num_attempts': 29, 'num_failed': 23, 'avg_failure_interval': '155s'})

    d_md = transform.__timesplit_to_d_md(time_group)

    assert d_md == expected_d_md
